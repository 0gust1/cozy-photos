// Generated by CoffeeScript 1.9.1
var fs, gm, log, mime, thumb, whiteList,
  indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };

fs = require('fs');

gm = require('gm');

mime = require('mime');

log = require('printit')({
  prefix: 'thumbnails'
});

whiteList = ['image/jpeg', 'image/png'];

module.exports = thumb = {
  readMetadata: function(filePath, callback) {
    return gm(filePath).options({
      imageMagick: true
    }).identify(function(err, data) {
      var metadata, orientation;
      if (err) {
        return callback(err);
      } else {
        orientation = data.Orientation;
        if (!(orientation != null) || data.Orientation === 'Undefined') {
          orientation = 1;
        }
        metadata = {
          exif: {
            orientation: orientation,
            date: data.Properties['date:create']
          }
        };
        return callback(null, metadata);
      }
    });
  },
  attachFile: function(file, dstPath, name, callback) {
    return file.attachBinary(dstPath, {
      name: name
    }, function(err) {
      return fs.unlink(dstPath, function(unlinkErr) {
        if (err) {
          console.log(unlinkErr);
        }
        return callback(err);
      });
    });
  },
  resize: function(srcPath, file, name, callback) {
    var attachFile, buildThumb, dstPath, err, gmRunner;
    dstPath = "/tmp/2-" + file.id;
    try {
      attachFile = (function(_this) {
        return function(err) {
          if (err) {
            return callback(err);
          } else {

          }
        };
      })(this);
      gmRunner = gm(srcPath).options({
        imageMagick: true
      });
      if (name === 'thumb') {
        buildThumb = function(width, height) {
          return gmRunner.resize(width, height).crop(300, 300, 0, 0).write(dstPath, function(err) {
            if (err) {
              return callback(err);
            } else {
              return thumb.attachFile(file, dstPath, name, callback);
            }
          });
        };
        return gmRunner.size(function(err, data) {
          if (err) {
            return callback(err);
          } else {
            if (data.width > data.height) {
              return buildThumb(null, 300);
            } else {
              return buildThumb(300, null);
            }
          }
        });
      } else if (name === 'screen') {
        return gmRunner.resize(1200, 800).write(dstPath, function(err) {
          if (err) {
            return callback(err);
          } else {
            return thumb.attachFile(file, dstPath, name, callback);
          }
        });
      }
    } catch (_error) {
      err = _error;
      console.log(err);
      return callback(err);
    }
  },
  create: function(file, callback) {
    var mimetype, rawFile, ref, stream;
    if (file.binary == null) {
      return callback(new Error('no binary'));
    }
    if (((ref = file.binary) != null ? ref.thumb : void 0) != null) {
      log.info("createThumb " + file.id + "/" + file.name + ": already created.");
      return callback();
    } else {
      mimetype = mime.lookup(file.name);
      if (indexOf.call(whiteList, mimetype) < 0) {
        log.debug("createThumb: " + file.id + " / " + file.name + ": No thumb to create for this kind of file.");
        return callback();
      } else {
        log.info("createThumb: " + file.id + " / " + file.name + ": Creation started...");
        rawFile = "/tmp/" + file.id;
        stream = file.getBinary('file', function(err) {
          if (err) {
            return callback(err);
          }
        });
        stream.pipe(fs.createWriteStream(rawFile));
        stream.on('error', callback);
        return stream.on('end', (function(_this) {
          return function() {
            return thumb.resize(rawFile, file, 'thumb', function(err) {
              return fs.unlink(rawFile, function() {
                if (err) {
                  console.log(err);
                } else {
                  log.info("createThumb " + file.id + " / " + file.name + ": Thumbnail created");
                }
                return callback(err);
              });
            });
          };
        })(this));
      }
    }
  }
};
